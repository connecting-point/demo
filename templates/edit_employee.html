<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Edit Employee</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body { background:#f8f9fa; font-family:system-ui, -apple-system, sans-serif; }
    .s { background:#fff; padding:1.5rem; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.05); margin-bottom:1.5rem; }
    .t { font-size:1.1rem; font-weight:600; color:#495057; margin-bottom:1rem; border-bottom:1px solid #dee2e6; padding-bottom:.5rem; }
    @media(max-width:576px){.col-md-6,.col-md-4{margin-bottom:.75rem}}
    .top-bar { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; margin-bottom:1.5rem; gap:0.75rem; }
    .btn-dashboard {
      background:linear-gradient(135deg,#343a40,#212529);
      color:#fff !important; border:none; border-radius:10px;
      padding:0.55rem 1rem; font-weight:600; transition:0.3s;
      box-shadow:0 3px 8px rgba(52,58,64,0.3); text-decoration:none;
    }
    .btn-dashboard:hover {
      transform:translateY(-1px);
      box-shadow:0 5px 14px rgba(52,58,64,0.5);
      color:#fff;
    }
    .logout-btn {
      background:linear-gradient(135deg,#dc3545,#b02a37);
      color:#fff; border:none; border-radius:25px;
      padding:0.45rem 1rem; font-weight:600; font-size:0.9rem;
      transition:0.3s; box-shadow:0 3px 8px rgba(220,53,69,0.3);
      text-decoration:none;
    }
    .logout-btn:hover {
      transform:translateY(-1px);
      box-shadow:0 5px 14px rgba(220,53,69,0.5);
      color:#fff;
    }
    #clock { font-weight:600; font-size:1rem; color:#198754; letter-spacing:0.5px; }
    .change-item { font-size: 0.95rem; }
    .change-item i { width: 20px; }
  </style>
</head>
<body class="bg-light">
<div class="container mt-4 mt-md-5">
  <!-- Header -->
  <div class="top-bar">
    <h2 class="mb-0 text-primary">Edit Employee</h2>
    <div class="d-flex align-items-center gap-3">
      <a href="{{ url_for('admin_dashboard') }}" class="btn-dashboard">Dashboard</a>
      <span id="clock"></span>
      <a href="/admin-logout" class="logout-btn">Logout</a>
    </div>
  </div>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          <i class="fa-solid {% if category=='success' %}fa-circle-check{% elif category=='danger' %}fa-circle-xmark{% else %}fa-info-circle{% endif %} me-2"></i>
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- CHANGE SUMMARY MODAL -->
  {% if session.get('changes') %}
  <div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,0.5);" id="changeModal">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">Updated Successfully!</h5>
          <button type="button" class="btn-close btn-close-white" onclick="this.closest('.modal').remove(); document.body.classList.remove('modal-open');"></button>
        </div>
        <div class="modal-body">
          <p class="mb-3"><strong>{{ session.changes|length }} field(s) updated:</strong></p>
          <div class="row g-3">
            {% for field, old, new in session.changes %}
            <div class="col-md-6">
              <div class="change-item d-flex align-items-center text-success">
                <i class="fa-solid fa-arrow-right text-success"></i>
                <div class="ms-2">
                  <strong>{{ field.replace('_', ' ')|title }}:</strong><br>
                  <small class="text-muted">Was: <em>{{ old or '—' }}</em></small><br>
                  <span class="text-success">Now: <strong>{{ new or '—' }}</strong></span>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" onclick="this.closest('.modal').remove(); document.body.classList.remove('modal-open');">
            Close
          </button>
          <a href="{{ url_for('employee_list') }}" class="btn btn-success">
            Go to Employee List
          </a>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  {% set _ = session.pop('changes', None) %}

  <!-- Form -->
  <form method="POST" enctype="multipart/form-data" id="form">
    <!-- REMOVED: <input type="hidden" name="username"...> -->

    <!-- Personal -->
    <div class="s">
      <div class="t">Personal Info</div>
      <div class="row g-3">
        <div class="col-md-6"><label class="form-label">Name *</label><input name="name" class="form-control" value="{{ emp.name }}" required></div>
        <div class="col-md-6"><label class="form-label">Email *</label><input name="email" type="email" class="form-control" value="{{ emp.email }}" required></div>
        <div class="col-md-6"><label class="form-label">Mobile (Login ID) *</label>
          <input id="mobile" name="mobile" type="text" pattern="\d{10}" maxlength="10" class="form-control"
                 value="{{ emp.mobile }}" required><small class="text-muted">Used as username</small>
        </div>
        <div class="col-md-6"><label class="form-label">Password *</label><input name="password" class="form-control" value="{{ emp.password }}" required></div>
        <div class="col-md-6"><label class="form-label">Aadhaar</label><input name="aadhaar" class="form-control" value="{{ emp.aadhaar or '' }}"></div>
        <div class="col-md-12"><label class="form-label">Address</label><textarea name="address" class="form-control" rows="2">{{ emp.address or '' }}</textarea></div>
      </div>
    </div>

    <!-- Family -->
    <div class="s">
      <div class="t">Family & Social</div>
      <div class="row g-3">
        <div class="col-md-6"><label class="form-label">Father's Mobile</label><input name="father_mobile" class="form-control" value="{{ emp.father_mobile or '' }}"></div>
        <div class="col-md-6"><label class="form-label">Wife/Mother Mobile</label><input name="wife_or_mother_mobile" class="form-control" value="{{ emp.wife_or_mother_mobile or '' }}"></div>
        <div class="col-md-12"><label class="form-label">Facebook Link</label><input name="facebook_profile" type="url" class="form-control" value="{{ emp.facebook_profile or '' }}"></div>
      </div>
    </div>

    <!-- Job & Shift -->
    <div class="s">
      <div class="t">Job & Shift</div>
      <div class="row g-3">
        <div class="col-md-4"><label class="form-label">Joining Date</label><input name="joining_date" type="date" class="form-control" value="{{ emp.joining_date or '' }}"></div>
        <div class="col-md-4"><label class="form-label">Designation</label><input name="designation" class="form-control" value="{{ emp.designation or '' }}"></div>
        <div class="col-md-4"><label class="form-label">Status</label>
          <select name="status" class="form-select">
            <option value="Working" {% if emp.status == 'Working' %}selected{% endif %}>Working</option>
            <option value="Resigned" {% if emp.status == 'Resigned' %}selected{% endif %}>Resigned</option>
          </select>
        </div>
        <div class="col-md-6"><label class="form-label">Team *</label><input name="team" class="form-control" value="{{ emp.team or '' }}" required></div>
        <div class="col-md-6"><label class="form-label">Category</label>
          <select name="employee_category" class="form-select" required>
            <option value="Full-Time" {% if emp.employee_category == 'Full-Time' %}selected{% endif %}>Full-Time</option>
            <option value="Part-Time" {% if emp.employee_category == 'Part-Time' %}selected{% endif %}>Part-Time</option>
            <option value="Contract" {% if emp.employee_category == 'Contract' %}selected{% endif %}>Contract</option>
            <option value="Intern" {% if emp.employee_category == 'Intern' %}selected{% endif %}>Intern</option>
            <option value="Freelancer" {% if emp.employee_category == 'Freelancer' %}selected{% endif %}>Freelancer</option>
          </select>
        </div>
        <div class="col-md-6"><label class="form-label">Punch Rules</label>
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" name="no_out_punch" value="1" id="nop" {% if emp.no_out_punch %}checked{% endif %}>
            <label class="form-check-label text-danger fw-semibold" for="nop">No Out-Punch</label>
            <small class="text-muted d-block">For field staff</small>
          </div>
        </div>
        <div class="col-md-6"><label class="form-label">In Time</label><input name="in_time" type="time" class="form-control" value="{{ emp.in_time or '' }}"></div>
        <div class="col-md-6"><label class="form-label">Out Time</label><input name="out_time" type="time" class="form-control" value="{{ emp.out_time or '' }}"></div>
        <div class="col-md-6"><label class="form-label">₹/Hour</label><input name="per_hour_salary" type="number" step="0.01" class="form-control" value="{{ emp.per_hour_salary or '' }}"></div>
        <div class="col-md-6"><label class="form-label">Shift Hours</label><input name="shift_hours" type="number" class="form-control" value="{{ emp.shift_hours or 8 }}"></div>
        <div class="col-md-12"><label class="form-label">Week Off</label><br>
          {% set week_offs = (emp.week_off_days or '').split(',') %}
          {% for d in ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'] %}
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" name="week_off_days" value="{{ d }}" {% if d in week_offs %}checked{% endif %}>
              <label class="form-check-label">{{ d }}</label>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Office & Vehicle -->
    <div class="s">
      <div class="t">Office & Vehicle</div>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Office Staff (Location Restricted)</label>
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" name="office_staff" value="1" id="officeStaff" {% if emp.office_staff %}checked{% endif %}>
            <label class="form-check-label" for="officeStaff">Enable office location check</label>
          </div>
        </div>
        <div class="col-md-6">
          <label class="form-label">Vehicle Logbook</label>
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" name="vehicle_log_enabled" value="1" id="vehicleLog" {% if emp.vehicle_log_enabled %}checked{% endif %}>
            <label class="form-check-label" for="vehicleLog">Enable vehicle log entry</label>
          </div>
        </div>
        <div class="col-md-6">
          <label class="form-label">Role</label>
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" name="manager_role" value="1" id="managerRole" {% if emp.manager_role %}checked{% endif %}>
            <label class="form-check-label" for="managerRole">Manager</label>
          </div>
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" name="shop_manager_role" value="1" id="shopManagerRole" {% if emp.shop_manager_role %}checked{% endif %}>
            <label class="form-check-label" for="shopManagerRole">Shop Manager</label>
          </div>
        </div>
        <div class="col-md-4">
          <label class="form-label">Office Latitude</label>
          <input name="office_lat" class="form-control" value="{{ emp.office_lat or '' }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">Office Longitude</label>
          <input name="office_lon" class="form-control" value="{{ emp.office_lon or '' }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">Office Radius (m)</label>
          <input name="office_radius_m" class="form-control" value="{{ emp.office_radius_m or 200 }}">
        </div>
      </div>
    </div>

    <!-- Documents -->
    <div class="s">
      <div class="t">Documents</div>
      <div class="row g-3">
        {% set docs = [
          ('employee_photo', 'Photo'),
          ('aadhaar_photo', 'Aadhaar'),
          ('pan_card', 'PAN'),
          ('bank_passbook', 'Bank'),
          ('tenth_certificate', '10th'),
          ('other_certificate', 'Other')
        ] %}
        {% for field, label in docs %}
          <div class="col-md-6">
            <label class="form-label">{{ label }}</label>
            {% if emp[field] %}
              <div class="mb-2">
                <img src="{{ url_for('static', filename='uploads/' + emp[field]) }}" width="100" class="img-thumbnail">
                <div class="small text-muted">{{ emp[field] }}</div>
              </div>
            {% else %}
              <div class="mb-2 text-muted">No file</div>
            {% endif %}
            <input type="file" name="{{ field }}" class="form-control">
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="text-center mt-4">
      <button id="btn" type="submit" class="btn btn-primary btn-lg px-5">
        <span id="txt">Update</span>
        <span id="spin" class="spinner-border spinner-border-sm ms-2 d-none"></span>
      </button>
    </div>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.getElementById('form').onsubmit = () => {
    document.getElementById('txt').textContent = 'Updating...';
    document.getElementById('spin').classList.remove('d-none');
    document.getElementById('btn').disabled = true;
  };

  function updateClock() {
    const now = new Date();
    document.getElementById("clock").textContent = " " + now.toLocaleTimeString();
  }
  setInterval(updateClock, 1000);
  updateClock();

  // Auto-close modal after 6 seconds
  if (document.getElementById('changeModal')) {
    setTimeout(() => {
      const modal = document.getElementById('changeModal');
      if (modal) modal.remove();
      document.body.classList.remove('modal-open');
    }, 6000);
  }
</script>
</body>
</html>
