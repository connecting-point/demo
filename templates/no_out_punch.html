<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>No Out-Punch Logs | 360 Vision</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { background:#f8fafc; font-family:'Inter',sans-serif; color:#2d3748; }
    .container { max-width:1200px; margin:40px auto; padding:0 15px; }
    .header-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; flex-wrap:wrap; gap:1rem; }
    h2 { font-weight:700; color:#d63384; margin:0; font-size:1.5rem; }
    .btn-back { background:linear-gradient(135deg,#4a90e2,#357abd); color:#fff !important; font-weight:600; border:none; border-radius:25px; padding:.55rem 1.2rem; box-shadow:0 4px 10px rgba(74,144,226,.3); transition:all .3s; text-decoration:none; font-size:.9rem; }
    .btn-back:hover { transform:translateY(-2px); box-shadow:0 6px 16px rgba(74,144,226,.5); }
    .search-bar { position:relative; max-width:400px; }
    .search-bar input { padding-left:2.5rem; border-radius:25px; border:1px solid #cbd5e0; font-size:.95rem; }
    .search-bar .bi-search { position:absolute; left:14px; top:50%; transform:translateY(-50%); color:#718096; }
    .table { background:white; border-radius:12px; overflow:hidden; box-shadow:0 1px 8px rgba(0,0,0,.08); font-size:.95rem; }
    th { background:#343a40; color:#fff; font-weight:600; text-align:center; font-size:.9rem; }
    td { vertical-align:middle; text-align:center; padding:.75rem; }
    .photo { width:50px; height:50px; border-radius:50%; object-fit:cover; border:3px solid #e2e8f0; transition:all .2s; cursor:pointer; }
    .photo:hover { transform:scale(1.1); border-color:#4a90e2; box-shadow:0 0 0 3px rgba(74,144,226,.2); }
    .gps-link { color:#0d6efd; text-decoration:none; font-weight:500; }
    .gps-link:hover { text-decoration:underline; }
    .no-data { color:#718096; font-style:italic; }
    .btn-export { background:#28a745; color:white; border:none; border-radius:25px; padding:.55rem 1.2rem; font-weight:600; }
    .btn-export:hover { background:#218838; }
    .spinner { display:none; }
    .spinner.show { display:inline-block; }

    @media (max-width:768px){
      h2{font-size:1.3rem;}
      .photo{width:45px;height:45px;}
      .table{font-size:.85rem;}
      .btn-back,.btn-export{font-size:.8rem;padding:.5rem 1rem;}
      .header-bar{flex-direction:column;align-items:stretch;text-align:center;}
      .search-bar{max-width:100%;}
    }
  </style>
</head>
<body>
<div class="container">
  <!-- Header -->
  <div class="header-bar">
    <h2>No Out-Punch Employee Logs</h2>
    <div class="d-flex gap-2 flex-wrap justify-content-center">
      <form method="post" class="d-inline">
        <input type="hidden" name="export_excel" value="1">
        <button type="submit" class="btn btn-export">
          Export Excel
        </button>
      </form>
      <a href="{{ url_for('admin_dashboard') }}" class="btn-back">
        Back to Dashboard
      </a>
    </div>
  </div>

  <!-- Filters + Search -->
  <form method="get" class="row g-3 align-items-center mb-4">
    <div class="col-md-3">
      <label class="form-label fw-semibold">From Date</label>
      <input type="date" name="start_date" value="{{ start_date }}" class="form-control form-control-sm rounded-pill">
    </div>
    <div class="col-md-3">
      <label class="form-label fw-semibold">To Date</label>
      <input type="date" name="end_date" value="{{ end_date }}" class="form-control form-control-sm rounded-pill">
    </div>
    <div class="col-md-4 search-bar">
      <label class="form-label fw-semibold visually-hidden">Search</label>
      <i class="bi bi-search"></i>
      <input type="text" name="search" id="liveSearch" value="{{ search }}"
             placeholder="Search by name or mobile..." class="form-control form-control-sm">
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button type="submit" class="btn btn-primary w-100 btn-sm rounded-pill">
        <span class="spinner-border spinner-border-sm spinner" role="status"></span>
        Filter
      </button>
    </div>
  </form>

  <!-- Table -->
  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle" id="dataTable">
      <thead>
        <tr>
          <th>Photo</th>
          <th>Name</th>
          <th>Mobile</th>
          <th>Punched IN Time</th>
          <th>GPS Location</th>
          <th>Attendance Photo</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        {% if logs %}
          {% for emp in logs %}
            <tr data-name="{{ emp.name|lower }}" data-mobile="{{ emp.mobile }}">
              <td>
                {% if emp.employee_photo %}
                  <img class="photo"
                       src="{{ url_for('static', filename='uploads/' + emp.employee_photo) }}"
                       onerror="this.src='{{ url_for('static', filename='uploads/default_user.png') }}';"
                       alt="{{ emp.name }}">
                {% else %}
                  <img class="photo" src="{{ url_for('static', filename='uploads/default_user.png') }}" alt="Default">
                {% endif %}
              </td>
              <td class="fw-semibold text-capitalize">{{ emp.name }}</td>
              <td><a href="tel:{{ emp.mobile }}" class="text-decoration-none">{{ emp.mobile }}</a></td>
              <td class="fw-medium">{{ emp.in_time or '-' }}</td>
              <td>
                {% if emp.latitude and emp.longitude %}
                  <a class="gps-link" href="https://www.google.com/maps?q={{ emp.latitude }},{{ emp.longitude }}" target="_blank">
                    View Map
                  </a>
                {% else %}
                  <span class="text-muted">No GPS</span>
                {% endif %}
              </td>
              <td>
                {% if emp.photo_clean %}
                  <img class="photo"
                       src="{{ url_for('static', filename=emp.photo_clean) }}"
                       onerror="this.src='{{ url_for('static', filename='uploads/default_user.png') }}';"
                       alt="Attendance Photo">
                {% else %}
                  <span class="text-muted">No photo</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr id="noDataRow">
            <td colspan="6" class="text-center py-5 no-data">
              <i class="bi bi-check-circle-fill fs-1 text-success mb-3 d-block"></i>
              <strong>All employees have punched out!</strong><br>
              <small>No missing out-punch records found.</small>
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if total_pages > 1 %}
  <nav class="mt-4">
    <ul class="pagination justify-content-center">
      {% for p in range(1, total_pages + 1) %}
      <li class="page-item {% if p == page %}active{% endif %}">
        <a class="page-link"
           href="?start_date={{ start_date }}&end_date={{ end_date }}&search={{ search }}&page={{ p }}">{{ p }}</a>
      </li>
      {% endfor %}
    </ul>
  </nav>
  {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Debounced live search
  const searchInput = document.getElementById('liveSearch');
  const tableBody   = document.getElementById('tableBody');
  const rows        = tableBody.querySelectorAll('tr[data-name]');
  const noDataRow   = document.getElementById('noDataRow');
  let timeout;

  searchInput.addEventListener('input', () => {
    clearTimeout(timeout);
    timeout = setTimeout(() => {
      const q = searchInput.value.toLowerCase().trim();
      let visible = 0;
      rows.forEach(r => {
        const name   = r.getAttribute('data-name');
        const mobile = r.getAttribute('data-mobile');
        const match  = name.includes(q) || mobile.includes(q);
        r.style.display = match ? '' : 'none';
        if (match) visible++;
      });
      if (noDataRow) noDataRow.style.display = (visible===0 && q) ? '' : 'none';
    }, 300);
  });

  // Spinner on submit
  document.querySelector('form').addEventListener('submit', function () {
    this.querySelector('.spinner').classList.add('show');
  });
</script>
</body>
</html>
