<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Payroll Summary | 360 Vision</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background:#0b132b; color:#fff; font-family:'Poppins',sans-serif; }
    .card { background:#1c2541; border:none; border-radius:12px; box-shadow:0 0 25px rgba(0,0,0,0.3); }
    .table { color:#fff; }
    .table thead { background:#3a506b; color:#fff; }
    .table tbody tr:nth-child(even) { background:#1a1e3a; }
    .table tbody tr:nth-child(odd) { background:#16213e; }
    .badge { font-size:0.85rem; }
    .text-ot { color:#ffca28; font-weight:600; }

    /* ðŸ”´ Soft glowing animation for No In / No Out */
    .pulse-red {
      color:#ff5e5e;
      font-weight:600;
      animation:pulseGlow 2s infinite;
    }
    @keyframes pulseGlow {
      0%   { text-shadow:0 0 5px rgba(255,90,90,0.8); opacity:1; }
      50%  { text-shadow:0 0 12px rgba(255,90,90,0.4); opacity:0.7; }
      100% { text-shadow:0 0 5px rgba(255,90,90,0.8); opacity:1; }
    }

    .alert-info { background:#23395d; border:none; color:#fff; }
    .btn-dark { background:#1c2541; border:none; }
    .btn-dark:hover { background:#3a506b; }
    .page-link { background:#1c2541; color:#fff; border:none; }
    .page-item.active .page-link { background:#3a506b; border:none; }
    .table-secondary { background:#3a506b !important; color:#fff !important; }

    /* ðŸ“± Mobile tweaks */
    @media (max-width:768px){
      .container{padding:0 10px;}
      .card{padding:15px;}
      .btn{font-size:0.8rem;padding:0.4rem 0.8rem;}
      .table-responsive{font-size:0.85rem;}
      .badge{font-size:0.7rem;}
      .text-ot{font-size:0.8rem;}
    }
  </style>
</head>
<body>
<div class="container my-4">
  <a href="{{ url_for('payroll_index') }}" class="btn btn-dark mb-3 shadow-sm">
    <i class="bi bi-arrow-left-circle"></i> Back
  </a>

  <div class="card shadow border-0 rounded-4">
    <div class="card-body">
      <!-- ðŸ‘¤ Employee Info -->
      <div class="d-flex align-items-center mb-4 flex-wrap gap-3">
        <img src="{{ url_for('static', filename='uploads/' + employee['employee_photo']) }}"
             alt="Employee Photo"
             class="rounded-circle border shadow"
             style="width:70px;height:70px;object-fit:cover;">
        <div class="flex-grow-1">
          <h4 class="mb-0 text-info fw-bold">{{ employee['username'] }}</h4>
          <small class="text-light opacity-75">Payroll Summary â€“ {{ employee['name'] }}</small>
          <div class="alert alert-info mt-3 d-flex flex-wrap justify-content-between px-4 py-2 rounded-4 gap-2">
            <div><strong>Total Expenses:</strong> â‚¹{{ "%.2f"|format(total_expense) }}</div>
            <div><strong>Advance Taken:</strong> â‚¹{{ "%.2f"|format(total_advance) }}</div>
          </div>
        </div>
      </div>

      <!-- ðŸ“… Filter & Export -->
      <form method="post" class="row gx-3 gy-2 align-items-end mb-4">
        <div class="col-md-4">
          <label class="form-label fw-semibold">From Date</label>
          <input type="date" name="start_date" value="{{ start_date }}" class="form-control rounded-pill shadow-sm" required>
        </div>
        <div class="col-md-4">
          <label class="form-label fw-semibold">To Date</label>
          <input type="date" name="end_date" value="{{ end_date }}" class="form-control rounded-pill shadow-sm" required>
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-outline-info w-100 rounded-pill shadow-sm">
            <i class="bi bi-funnel-fill"></i> Filter
          </button>
        </div>
        <div class="col-md-2">
          <button type="submit" name="export_excel" value="1" class="btn btn-success w-100 rounded-pill shadow-sm">
            <i class="bi bi-file-earmark-excel"></i> Export
          </button>
        </div>
      </form>

      <!-- ðŸ§¾ Attendance Table -->
      <div class="table-responsive">
        <table class="table table-bordered text-center align-middle">
          <thead>
            <tr>
              <th>Date</th>
              <th>Day</th>
              <th>In Time</th>
              <th>Out Time</th>
              <th>Status</th>
              <th>Base Hrs</th>
              <th class="text-ot">OT Hrs</th>
              <th class="text-ot">OT Pay</th>
              <th>Salary (â‚¹)</th>
            </tr>
          </thead>
          <tbody>
            {% for r in records_paginated %}
            <tr>
              <td>{{ r.date }}</td>
              <td>{{ r.day }}</td>

              <!-- â° In Time -->
              <td>
                {% if r.in_time not in ['.', '-'] %}
                  {{ r.in_time }}
                {% elif r.in_time == '.' %}
                  <span class="pulse-red">No In</span>
                {% else %}
                  {{ r.in_time }}
                {% endif %}
              </td>

              <!-- â± Out Time -->
              <td>
                {% if r.out_time not in ['.', '-'] %}
                  {{ r.out_time }}
                {% elif r.out_time == '.' %}
                  <span class="pulse-red">No Out</span>
                {% else %}
                  {{ r.out_time }}
                {% endif %}
              </td>

              <!-- ðŸŸ¢ Status -->
              <td>
                {% if r.status == 'Present' %}
                  <span class="badge bg-success">{{ r.status }}</span>
                {% elif r.status == 'Half-Day' %}
                  <span class="badge bg-warning text-dark">{{ r.status }}</span>
                {% elif r.status == 'Week Off' %}
                  <span class="badge bg-info text-dark">{{ r.status }}</span>
                {% else %}
                  <span class="badge bg-danger">{{ r.status }}</span>
                {% endif %}
              </td>

              <td>{{ "%.2f"|format(r.base_hours) }}</td>
              <td class="text-ot">{{ "%.2f"|format(r.ot_hours) }}</td>
              <td class="text-ot">â‚¹ {{ "%.2f"|format(r.ot_pay) }}</td>
              <td>â‚¹ {{ "%.2f"|format(r.salary) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- ðŸ“„ Pagination -->
      <nav class="mt-3">
        <ul class="pagination justify-content-center">
          {% for p in range(1, total_pages + 1) %}
          <li class="page-item {% if p == page %}active{% endif %}">
            <a class="page-link"
               href="?start_date={{ start_date }}&end_date={{ end_date }}&page={{ p }}">{{ p }}</a>
          </li>
          {% endfor %}
        </ul>
      </nav>

      <!-- ðŸ“Š Weekly Summary -->
      <h5 class="mt-5 text-info"><i class="bi bi-calendar-week"></i> Weekly Summary</h5>
      <div class="table-responsive">
        <table class="table table-sm table-bordered text-center align-middle mt-2">
          <thead class="table-secondary">
            <tr>
              <th>Week</th>
              <th>Present</th>
              <th>Absent</th>
              <th>Half-Day</th>
              <th>Week Off</th>
              <th>Total Salary (â‚¹)</th>
              <th class="text-ot">Total OT Pay</th>
            </tr>
          </thead>
          <tbody>
            {% for week in weekly_summary %}
            <tr>
              <td>{{ week.week_range }}</td>
              <td>{{ week.present }}</td>
              <td>{{ week.absent }}</td>
              <td>{{ week.half_day }}</td>
              <td>{{ week.week_off }}</td>
              <td>â‚¹ {{ "%.2f"|format(week.total_salary) }}</td>
              <td class="text-ot">â‚¹ {{ "%.2f"|format(week.total_ot_pay) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- âœ… Summary -->
      <div class="mt-4 text-end fs-6 fw-semibold">
        <span class="text-success me-3"><i class="bi bi-check-circle-fill"></i> Total Present: {{ total_present }}</span>
        <span class="text-danger me-3"><i class="bi bi-x-circle-fill"></i> Absent: {{ total_absent }}</span>
        <span class="text-warning me-3"><i class="bi bi-circle-half"></i> Half-Day: {{ total_half_day }}</span>
        <span class="text-info me-3"><i class="bi bi-moon-fill"></i> Week Off: {{ total_week_off }}</span>
        <div class="mt-2">
          <span class="text-ot me-3"><i class="bi bi-clock-history"></i> Total OT Pay: â‚¹ {{ "%.2f"|format(total_ot_pay) }}</span>
          <span class="fs-5 text-success">Total Salary: â‚¹ {{ "%.2f"|format(total) }}</span>
        </div>
      </div>
    </div>
  </div>
</div>
</body>
</html>

